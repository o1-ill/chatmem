<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>chatmem โ ุฏุฑุฏุด ูุน ุงูุฐูุงุก ุงูุงุตุทูุงุนู</title>

  <!-- Tailwind CDN (ุชุตููู ุนุตุฑู ุณุฑูุน) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase SDKs (compat ูููุฒูุฏ ูู ุงูุจุณุงุทุฉ) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <style>
    body { direction: rtl; }
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.15); border-radius: 10px; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4">

  <div class="w-full max-w-5xl bg-white rounded-2xl shadow-lg overflow-hidden grid grid-cols-1 lg:grid-cols-3">
    <!-- Sidebar -->
    <aside class="p-6 border-b lg:border-b-0 lg:border-r">
      <div class="flex items-center gap-3">
        <img src="https://static.thenounproject.com/png/3407196-200.png" class="w-12 h-12" alt="logo">
        <div>
          <h1 class="text-xl font-semibold">chatmem</h1>
          <p class="text-xs text-gray-500">ุฏุฑุฏุดุฉ ุฐููุฉ ุฎุงุตุฉ ุจุญุณุงุจู</p>
        </div>
      </div>

      <div id="authSection" class="mt-6">
        <button id="googleSignBtn" class="w-full bg-red-500 text-white py-2 rounded-lg hover:opacity-95">
          ุชุณุฌูู ุงูุฏุฎูู ุจุฌูููู
        </button>
        <button id="signOutBtn" class="w-full mt-2 bg-gray-200 text-gray-700 py-2 rounded-lg hidden">
          ุชุณุฌูู ุงูุฎุฑูุฌ
        </button>
        <p id="userEmail" class="text-sm text-gray-600 mt-3"></p>
      </div>

      <hr class="my-4">

      <div>
        <h3 class="text-sm text-gray-600">ุงููุญุงุฏุซุงุช</h3>
        <ul id="conversationsList" class="mt-3 space-y-2 max-h-48 overflow-auto"></ul>
      </div>

      <div class="mt-4 text-xs text-gray-500">
        <p>ููุงุญุธุฉ: ูู ุญุณุงุจ ูู ูุงุนุฏุฉ ุจูุงูุงุช ูููุตูุฉ ูุญููุธุฉ ูู Firebase Firestore.</p>
      </div>
    </aside>

    <!-- Main Chat -->
    <main class="col-span-2 p-6 flex flex-col">
      <div class="flex-1 flex flex-col gap-4 overflow-hidden">
        <!-- ุนููุงู ุงููุญุงุฏุซุฉ -->
        <div class="flex items-center justify-between">
          <h2 id="chatTitle" class="text-lg font-medium">ูุฑุญุจุงู โ ุงุจุฏุฃ ุจุงูุณุคุงู</h2>
          <div class="text-sm text-gray-500">ูุงุฌูุฉ ุชุดุจู ChatGPT โ ูุน ุจุญุซ ููุจ ูุฑูุน ุตูุฑ</div>
        </div>

        <!-- ุงูุฑุณุงุฆู -->
        <div id="messages" class="flex-1 overflow-auto p-4 bg-gray-50 rounded-lg space-y-3">
          <!-- ุฑุณุงุฆู ุณุชูุฏุฑุฌ ููุง -->
        </div>
      </div>

      <!-- ููุญุฉ ุงูุฅุฏุฎุงู -->
      <div class="mt-4 border-t pt-4">
        <form id="chatForm" class="flex gap-3">
          <input id="messageInput" type="text" placeholder="ุงุณุฃููู ุฃู ุดูุก..." class="flex-1 p-3 rounded-lg border" autocomplete="off" />
          <label class="flex items-center gap-2">
            <input id="imageInput" type="file" accept="image/*" class="hidden" />
            <button type="button" id="attachBtn" class="px-3 py-2 bg-blue-50 rounded-lg border">๐ท</button>
          </label>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg">ุฅุฑุณุงู</button>
        </form>

        <div id="status" class="text-xs text-gray-500 mt-2"></div>
      </div>
    </main>
  </div>

<script>
/* ======================================
   ุฅุนุฏุงุฏุงุช ูุฌุจ ุชุนุฏูููุง ูุจู ุงููุดุฑ
   ======================================
   1) ุถุน ููุง Firebase config ุงูุฎุงุต ุจูุดุฑูุนู.
   2) ุถุน ุฑุงุจุท ููุทุฉ ุงูููุงูุฉ ุงูุฎูููุฉ (backend) ูู BACKEND_ENDPOINT.
      ุฅุฐุง ูู ุชูู ุชููู backend ุจุนุฏุ ุณูุชู ุชุดุบูู "ูุถุน ุงูุงุฎุชุจุงุฑ ุงููุญูู" mock mode.
*/

const FIREBASE_CONFIG = {
  apiKey: "REPLACE_WITH_FIREBASE_APIKEY",
  authDomain: "REPLACE_WITH_PROJECT.firebaseapp.com",
  projectId: "REPLACE_WITH_PROJECT_ID",
  storageBucket: "REPLACE_WITH_PROJECT.appspot.com",
  messagingSenderId: "SENDER_ID",
  appId: "APP_ID",
};

// ููุทุฉ ุงูููุงูุฉ ุงูุฎูููุฉ: ุงุณุชุจุฏููุง ุจุนููุงู ุณูุฑูุฑู/Cloud Function
const BACKEND_ENDPOINT = "REPLACE_WITH_YOUR_BACKEND_ENDPOINT"; // e.g. https://us-central1-.../api/search_and_answer

/* ======================================
   ุชููุฆุฉ Firebase
   ====================================== */
firebase.initializeApp(FIREBASE_CONFIG);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

/* ุนูุงุตุฑ DOM */
const googleSignBtn = document.getElementById('googleSignBtn');
const signOutBtn = document.getElementById('signOutBtn');
const userEmail = document.getElementById('userEmail');
const messagesDiv = document.getElementById('messages');
const chatForm = document.getElementById('chatForm');
const messageInput = document.getElementById('messageInput');
const statusDiv = document.getElementById('status');
const conversationsList = document.getElementById('conversationsList');
const attachBtn = document.getElementById('attachBtn');
const imageInput = document.getElementById('imageInput');
const chatTitle = document.getElementById('chatTitle');

let currentUser = null;
let currentConversationId = null;

/* ุชุณุฌูู ุงูุฏุฎูู ุจุฌูุฌู */
googleSignBtn.addEventListener('click', async () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  try {
    await auth.signInWithPopup(provider);
  } catch (err) {
    alert('ุฎุทุฃ ูู ุชุณุฌูู ุงูุฏุฎูู: ' + err.message);
  }
});

signOutBtn.addEventListener('click', () => auth.signOut());

auth.onAuthStateChanged(async user => {
  if (user) {
    currentUser = user;
    userEmail.textContent = user.email;
    googleSignBtn.classList.add('hidden');
    signOutBtn.classList.remove('hidden');

    await loadConversations();
    await openOrCreateConversation();
  } else {
    currentUser = null;
    userEmail.textContent = '';
    googleSignBtn.classList.remove('hidden');
    signOutBtn.classList.add('hidden');
    messagesDiv.innerHTML = '';
    conversationsList.innerHTML = '';
  }
});

/* ุชุญููู ูุงุฆูุฉ ุงููุญุงุฏุซุงุช */
async function loadConversations() {
  if (!currentUser) return;
  const q = await db.collection('users').doc(currentUser.uid).collection('conversations')
    .orderBy('updatedAt', 'desc').limit(20).get();

  conversationsList.innerHTML = '';
  q.forEach(doc => {
    const data = doc.data();
    const li = document.createElement('li');
    li.className = 'p-2 bg-white rounded-lg shadow-sm cursor-pointer hover:bg-blue-50';
    li.textContent = data.title || 'ูุญุงุฏุซุฉ ุฌุฏูุฏุฉ';
    li.addEventListener('click', () => loadConversationMessages(doc.id));
    conversationsList.appendChild(li);
  });
}

/* ูุชุญ ุฃู ุฅูุดุงุก ูุญุงุฏุซุฉ */
async function openOrCreateConversation() {
  if (!currentUser) return;
  const convRef = await db.collection('users').doc(currentUser.uid).collection('conversations').add({
    title: 'ูุญุงุฏุซุฉ ุฌุฏูุฏุฉ',
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  currentConversationId = convRef.id;
  chatTitle.textContent = 'ูุญุงุฏุซุฉ ุฌุฏูุฏุฉ';
  messagesDiv.innerHTML = '';
}

/* ุชุญููู ุฑุณุงุฆู */
async function loadConversationMessages(convId) {
  if (!currentUser) return;
  currentConversationId = convId;
  chatTitle.textContent = 'ุชุญููู ุงูุฑุณุงุฆู...';
  messagesDiv.innerHTML = '';

  const msgsSnapshot = await db.collection('users').doc(currentUser.uid)
    .collection('conversations').doc(convId).collection('messages')
    .orderBy('createdAt','asc').get();

  msgsSnapshot.forEach(doc => appendMessageToUI(doc.data()));
  chatTitle.textContent = 'ูุญุงุฏุซุฉ';
}

/* ุฅุถุงูุฉ ุฑุณุงูุฉ ุฅูู ุงููุงุฌูุฉ */
function appendMessageToUI(msg) {
  const wrapper = document.createElement('div');
  wrapper.className = msg.role === 'user' ? 'text-right' : 'text-left';

  const bubble = document.createElement('div');
  bubble.className = (msg.role === 'user' ? 'inline-block bg-blue-600 text-white' : 'inline-block bg-gray-100 text-gray-800') +
    ' p-3 rounded-lg max-w-[80%]';

  bubble.innerHTML = msg.text.replace(/\n/g, '<br>');
  wrapper.appendChild(bubble);

  if (msg.imageUrl) {
    const img = document.createElement('img');
    img.src = msg.imageUrl;
    img.className = 'mt-2 rounded-md max-h-40';
    wrapper.appendChild(img);
  }

  messagesDiv.appendChild(wrapper);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

/* ุฅุฑุณุงู ุฑุณุงูุฉ */
chatForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  if (!currentUser) { alert('ุณุฌู ุงูุฏุฎูู ุฃููุงู.'); return; }
  const text = messageInput.value.trim();
  const file = imageInput.files[0];
  if (!text && !file) return;

  statusDiv.textContent = 'ุฌุงุฑู ุงููุนุงูุฌุฉ...';

  let imageUrl = null;
  if (file) {
    const storageRef = storage.ref().child(`${currentUser.uid}/images/${Date.now()}_${file.name}`);
    await storageRef.put(file);
    imageUrl = await storageRef.getDownloadURL();
  }

  const messageDoc = {
    role: 'user',
    text: text || '[ุตูุฑุฉ ูุฑููุฉ]',
    imageUrl: imageUrl || null,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  const messagesCol = db.collection('users').doc(currentUser.uid)
    .collection('conversations').doc(currentConversationId).collection('messages');

  await messagesCol.add(messageDoc);
  appendMessageToUI({ ...messageDoc, createdAt: new Date() });

  try {
    let reply = null;
    // ุฅุฐุง ูู ูุชู ุชุนููู BACKEND_ENDPOINTุ ูุดุบูู mock local responder ูุชูููู ุงูุงุฎุชุจุงุฑ ุงููุญูู
    if (!BACKEND_ENDPOINT || BACKEND_ENDPOINT.includes('REPLACE_WITH')) {
      reply = await mockLocalResponder({ query: text, imageUrl });
    } else {
      const payload = { uid: currentUser.uid, conversationId: currentConversationId, query: text, imageUrl };
      const res = await fetch(BACKEND_ENDPOINT, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      if (!res.ok) throw new Error('ุฎุทุฃ ูู ุงูุฎุงุฏู: ' + res.status);
      const data = await res.json();
      reply = { text: data.answer || 'ูู ุฃุชููู ูู ุงูุนุซูุฑ ุนูู ุฅุฌุงุจุฉ ููุงุณุจุฉ.', sources: data.sources || [] };
    }

    const answerMsg = { role: 'assistant', text: reply.text || reply, sources: reply.sources || [], createdAt: firebase.firestore.FieldValue.serverTimestamp() };
    await messagesCol.add(answerMsg);
    appendMessageToUI({ ...answerMsg, createdAt: new Date() });
    statusDiv.textContent = 'ุชู ุงูุฑุฏ.';
  } catch (err) {
    console.error(err);
    statusDiv.textContent = 'ุญุตู ุฎุทุฃ ุฃุซูุงุก ุทูุจ ุงูุฅุฌุงุจุฉ: ' + err.message;
    appendMessageToUI({ role: 'assistant', text: 'ุญุตู ุฎุทุฃ ุฃุซูุงุก ุฌูุจ ุงูุฅุฌุงุจุฉ. ุฌุฑุจ ูุงุญูุงู.' });
  }

  messageInput.value = '';
  imageInput.value = '';
});

attachBtn.addEventListener('click', () => imageInput.click());

/* ======================================
   Mock local responder (ูุณูุญ ุจุชุฌุฑุจุฉ ุงููุงุฌูุฉ ุจุฏูู backend)
   ูุฐู ุงูููุฒุฉ ูุฌุฑุฏ ูุณุงุนุฏุฉ ููุงุฎุชุจุงุฑ โ ูุง ุชุนุชูุฏ ุนูููุง ูุฅูุชุงุฌ ุฅุฌุงุจุงุช ุฏูููุฉ.
   - ุชุญูู ุงูุณุคุงู ุจุดูู ุจุณูุท ูุชุนุทู ุฑุฏ ุชุฌุฑูุจู
   - ุฅุฐุง ุฃุฑุณูุช ุตูุฑุฉุ ุณุชุนุทู ุฅุฌุงุจุฉ ูุฎุชุตุฑุฉ ุชุดูุฑ ุฅูู ุฃููุง ุงุณุชููุช ุงูุตูุฑุฉ
   ====================================== */
async function mockLocalResponder({ query, imageUrl }) {
  await new Promise(r => setTimeout(r, 800)); // ูุญุงูุงุฉ ุฒูู ุงูุดุจูุฉ
  if (imageUrl && (!query || query.trim() === '')) {
    return { text: 'ููุฏ ุงุณุชููุช ุงูุตูุฑุฉ. ููููู ุณุคุงูู ุนู ูุญุชููุงุชูุง (ูุซูุงู: ูุง ูุฐุง ุงูููุชุฌุ) ูุณุฃุญุงูู ุงูุจุญุซ ุนููุง.' };
  }
  if (!query) return { text: 'ูุฑุญุจุงู! ุงุณุฃููู ุฃู ุดูุก ุนู ุงูุจุฑูุฌุฉุ ุงูุชุงุฑูุฎุ ุงููุตุงุฆุญ ุงูููููุฉ... ุณุฃุฑุฏ ุจุทุฑููุฉ ูุฑุชุจุฉ.' };

  // ุชุญููู ุงูุณุคุงู ุฅูู ุฅุฌุงุจุฉ ุชุฌุฑูุจูุฉ ุจุงุณุชุฎุฏุงู ููุงุนุฏ ุจุณูุทุฉ
  const lower = query.toLowerCase();
  if (lower.includes('ููู') || lower.includes('ุดูู') || lower.includes('ูุงูู') || lower.includes('ูุง ูู')) {
    return { text: 'ูุฐู ุฅุฌุงุจุฉ ุชุฌุฑูุจูุฉ: ุนุงุฏุฉู ุณุฃุจุญุซ ูู ุงูููุจ ุนู ูุตุงุฏุฑ ููุซููุฉุ ุฃุณุชุฎูุต ุงููุนูููุงุช ุงููุชูุฑุฑุฉุ ุซู ุฃุนูุฏ ุตูุงุบุชูุง ูุชุธูุฑ ุจุดูู ูุฑุชุจ ูููุฌุฒ.' };
  }
  return { text: 'ุฅุฌุงุจุฉ ุชุฌุฑูุจูุฉ: ูู ุฃุชููู ูู ุงููุตูู ุฅูู ุฎุงุฏู ุงูุจุญุซ. ููููู ุชุนููู BACKEND_ENDPOINT ูู ููู HTML ุฅูู ููุทุฉ ููุงูุฉ ุงูุฎุงุฏู ุงูุฎุงุต ุจู ูุชูุนูู ุงูุจุญุซ ูู ุงูููุจ ูุฅุนุงุฏุฉ ุงูุตูุงุบุฉ.' };
}

</script>

</body>
</html>
