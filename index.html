<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>chatmem — دردش مع الذكاء الاصطناعي</title>

  <!-- Tailwind CDN (تصميم عصري سريع) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase SDKs (compat للمزيد من البساطة) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <style>
    body { direction: rtl; }
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.15); border-radius: 10px; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4">

  <div class="w-full max-w-5xl bg-white rounded-2xl shadow-lg overflow-hidden grid grid-cols-1 lg:grid-cols-3">
    <!-- Sidebar -->
    <aside class="p-6 border-b lg:border-b-0 lg:border-r">
      <div class="flex items-center gap-3">
        <img src="https://static.thenounproject.com/png/3407196-200.png" class="w-12 h-12" alt="logo">
        <div>
          <h1 class="text-xl font-semibold">chatmem</h1>
          <p class="text-xs text-gray-500">دردشة ذكية خاصة بحسابك</p>
        </div>
      </div>

      <div id="authSection" class="mt-6">
        <button id="googleSignBtn" class="w-full bg-red-500 text-white py-2 rounded-lg hover:opacity-95">
          تسجيل الدخول بجيميل
        </button>
        <button id="signOutBtn" class="w-full mt-2 bg-gray-200 text-gray-700 py-2 rounded-lg hidden">
          تسجيل الخروج
        </button>
        <p id="userEmail" class="text-sm text-gray-600 mt-3"></p>
      </div>

      <hr class="my-4">

      <div>
        <h3 class="text-sm text-gray-600">المحادثات</h3>
        <ul id="conversationsList" class="mt-3 space-y-2 max-h-48 overflow-auto"></ul>
      </div>

      <div class="mt-4 text-xs text-gray-500">
        <p>ملاحظة: كل حساب له قاعدة بيانات منفصلة محفوظة في Firebase Firestore.</p>
      </div>
    </aside>

    <!-- Main Chat -->
    <main class="col-span-2 p-6 flex flex-col">
      <div class="flex-1 flex flex-col gap-4 overflow-hidden">
        <!-- عنوان المحادثة -->
        <div class="flex items-center justify-between">
          <h2 id="chatTitle" class="text-lg font-medium">مرحباً — ابدأ بالسؤال</h2>
          <div class="text-sm text-gray-500">واجهة تشبه ChatGPT — مع بحث ويب ورفع صور</div>
        </div>

        <!-- الرسائل -->
        <div id="messages" class="flex-1 overflow-auto p-4 bg-gray-50 rounded-lg space-y-3">
          <!-- رسائل ستُدرج هنا -->
        </div>
      </div>

      <!-- لوحة الإدخال -->
      <div class="mt-4 border-t pt-4">
        <form id="chatForm" class="flex gap-3">
          <input id="messageInput" type="text" placeholder="اسألني أي شيء..." class="flex-1 p-3 rounded-lg border" autocomplete="off" />
          <label class="flex items-center gap-2">
            <input id="imageInput" type="file" accept="image/*" class="hidden" />
            <button type="button" id="attachBtn" class="px-3 py-2 bg-blue-50 rounded-lg border">📷</button>
          </label>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg">إرسال</button>
        </form>

        <div id="status" class="text-xs text-gray-500 mt-2"></div>
      </div>
    </main>
  </div>

<script>
/* ======================================
   إعدادات يجب تعديلها قبل النشر
   ======================================
   1) ضع هنا Firebase config الخاص بمشروعك.
   2) ضع رابط نقطة النهاية الخلفية (backend) في BACKEND_ENDPOINT.
      إذا لم تكن تملك backend بعد، سيتم تشغيل "وضع الاختبار المحلي" mock mode.
*/

const FIREBASE_CONFIG = {
  apiKey: "REPLACE_WITH_FIREBASE_APIKEY",
  authDomain: "REPLACE_WITH_PROJECT.firebaseapp.com",
  projectId: "REPLACE_WITH_PROJECT_ID",
  storageBucket: "REPLACE_WITH_PROJECT.appspot.com",
  messagingSenderId: "SENDER_ID",
  appId: "APP_ID",
};

// نقطة النهاية الخلفية: استبدلها بعنوان سيرفرك/Cloud Function
const BACKEND_ENDPOINT = "REPLACE_WITH_YOUR_BACKEND_ENDPOINT"; // e.g. https://us-central1-.../api/search_and_answer

/* ======================================
   تهيئة Firebase
   ====================================== */
firebase.initializeApp(FIREBASE_CONFIG);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

/* عناصر DOM */
const googleSignBtn = document.getElementById('googleSignBtn');
const signOutBtn = document.getElementById('signOutBtn');
const userEmail = document.getElementById('userEmail');
const messagesDiv = document.getElementById('messages');
const chatForm = document.getElementById('chatForm');
const messageInput = document.getElementById('messageInput');
const statusDiv = document.getElementById('status');
const conversationsList = document.getElementById('conversationsList');
const attachBtn = document.getElementById('attachBtn');
const imageInput = document.getElementById('imageInput');
const chatTitle = document.getElementById('chatTitle');

let currentUser = null;
let currentConversationId = null;

/* تسجيل الدخول بجوجل */
googleSignBtn.addEventListener('click', async () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  try {
    await auth.signInWithPopup(provider);
  } catch (err) {
    alert('خطأ في تسجيل الدخول: ' + err.message);
  }
});

signOutBtn.addEventListener('click', () => auth.signOut());

auth.onAuthStateChanged(async user => {
  if (user) {
    currentUser = user;
    userEmail.textContent = user.email;
    googleSignBtn.classList.add('hidden');
    signOutBtn.classList.remove('hidden');

    await loadConversations();
    await openOrCreateConversation();
  } else {
    currentUser = null;
    userEmail.textContent = '';
    googleSignBtn.classList.remove('hidden');
    signOutBtn.classList.add('hidden');
    messagesDiv.innerHTML = '';
    conversationsList.innerHTML = '';
  }
});

/* تحميل قائمة المحادثات */
async function loadConversations() {
  if (!currentUser) return;
  const q = await db.collection('users').doc(currentUser.uid).collection('conversations')
    .orderBy('updatedAt', 'desc').limit(20).get();

  conversationsList.innerHTML = '';
  q.forEach(doc => {
    const data = doc.data();
    const li = document.createElement('li');
    li.className = 'p-2 bg-white rounded-lg shadow-sm cursor-pointer hover:bg-blue-50';
    li.textContent = data.title || 'محادثة جديدة';
    li.addEventListener('click', () => loadConversationMessages(doc.id));
    conversationsList.appendChild(li);
  });
}

/* فتح أو إنشاء محادثة */
async function openOrCreateConversation() {
  if (!currentUser) return;
  const convRef = await db.collection('users').doc(currentUser.uid).collection('conversations').add({
    title: 'محادثة جديدة',
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  currentConversationId = convRef.id;
  chatTitle.textContent = 'محادثة جديدة';
  messagesDiv.innerHTML = '';
}

/* تحميل رسائل */
async function loadConversationMessages(convId) {
  if (!currentUser) return;
  currentConversationId = convId;
  chatTitle.textContent = 'تحميل الرسائل...';
  messagesDiv.innerHTML = '';

  const msgsSnapshot = await db.collection('users').doc(currentUser.uid)
    .collection('conversations').doc(convId).collection('messages')
    .orderBy('createdAt','asc').get();

  msgsSnapshot.forEach(doc => appendMessageToUI(doc.data()));
  chatTitle.textContent = 'محادثة';
}

/* إضافة رسالة إلى الواجهة */
function appendMessageToUI(msg) {
  const wrapper = document.createElement('div');
  wrapper.className = msg.role === 'user' ? 'text-right' : 'text-left';

  const bubble = document.createElement('div');
  bubble.className = (msg.role === 'user' ? 'inline-block bg-blue-600 text-white' : 'inline-block bg-gray-100 text-gray-800') +
    ' p-3 rounded-lg max-w-[80%]';

  bubble.innerHTML = msg.text.replace(/\n/g, '<br>');
  wrapper.appendChild(bubble);

  if (msg.imageUrl) {
    const img = document.createElement('img');
    img.src = msg.imageUrl;
    img.className = 'mt-2 rounded-md max-h-40';
    wrapper.appendChild(img);
  }

  messagesDiv.appendChild(wrapper);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

/* إرسال رسالة */
chatForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  if (!currentUser) { alert('سجل الدخول أولاً.'); return; }
  const text = messageInput.value.trim();
  const file = imageInput.files[0];
  if (!text && !file) return;

  statusDiv.textContent = 'جاري المعالجة...';

  let imageUrl = null;
  if (file) {
    const storageRef = storage.ref().child(`${currentUser.uid}/images/${Date.now()}_${file.name}`);
    await storageRef.put(file);
    imageUrl = await storageRef.getDownloadURL();
  }

  const messageDoc = {
    role: 'user',
    text: text || '[صورة مرفقة]',
    imageUrl: imageUrl || null,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  const messagesCol = db.collection('users').doc(currentUser.uid)
    .collection('conversations').doc(currentConversationId).collection('messages');

  await messagesCol.add(messageDoc);
  appendMessageToUI({ ...messageDoc, createdAt: new Date() });

  try {
    let reply = null;
    // إذا لم يتم تعيين BACKEND_ENDPOINT، نشغّل mock local responder لتمكين الاختبار المحلي
    if (!BACKEND_ENDPOINT || BACKEND_ENDPOINT.includes('REPLACE_WITH')) {
      reply = await mockLocalResponder({ query: text, imageUrl });
    } else {
      const payload = { uid: currentUser.uid, conversationId: currentConversationId, query: text, imageUrl };
      const res = await fetch(BACKEND_ENDPOINT, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      if (!res.ok) throw new Error('خطأ من الخادم: ' + res.status);
      const data = await res.json();
      reply = { text: data.answer || 'لم أتمكن من العثور على إجابة مناسبة.', sources: data.sources || [] };
    }

    const answerMsg = { role: 'assistant', text: reply.text || reply, sources: reply.sources || [], createdAt: firebase.firestore.FieldValue.serverTimestamp() };
    await messagesCol.add(answerMsg);
    appendMessageToUI({ ...answerMsg, createdAt: new Date() });
    statusDiv.textContent = 'تم الرد.';
  } catch (err) {
    console.error(err);
    statusDiv.textContent = 'حصل خطأ أثناء طلب الإجابة: ' + err.message;
    appendMessageToUI({ role: 'assistant', text: 'حصل خطأ أثناء جلب الإجابة. جرب لاحقاً.' });
  }

  messageInput.value = '';
  imageInput.value = '';
});

attachBtn.addEventListener('click', () => imageInput.click());

/* ======================================
   Mock local responder (يسمح بتجربة الواجهة بدون backend)
   هذه الميزة مجرد مساعدة للاختبار — لا تعتمد عليها لإنتاج إجابات دقيقة.
   - تحلل السؤال بشكل بسيط وتعطي رد تجريبي
   - إذا أرسلت صورة، ستعطي إجابة مختصرة تشير إلى أنها استلمت الصورة
   ====================================== */
async function mockLocalResponder({ query, imageUrl }) {
  await new Promise(r => setTimeout(r, 800)); // محاكاة زمن الشبكة
  if (imageUrl && (!query || query.trim() === '')) {
    return { text: 'لقد استلمت الصورة. يمكنك سؤالي عن محتوياتها (مثلاً: ما هذا المنتج؟) وسأحاول البحث عنها.' };
  }
  if (!query) return { text: 'مرحباً! اسألني أي شيء عن البرمجة، التاريخ، النصائح اليومية... سأرد بطريقة مرتبة.' };

  // تحويل السؤال إلى إجابة تجريبية باستخدام قواعد بسيطة
  const lower = query.toLowerCase();
  if (lower.includes('كيف') || lower.includes('شنو') || lower.includes('ماهي') || lower.includes('ما هو')) {
    return { text: 'هذه إجابة تجريبية: عادةً سأبحث في الويب عن مصادر موثوقة، أستخلص المعلومات المتكررة، ثم أعيد صياغتها لتظهر بشكل مرتب وموجز.' };
  }
  return { text: 'إجابة تجريبية: لم أتمكن من الوصول إلى خادم البحث. يمكنك تعيين BACKEND_ENDPOINT في ملف HTML إلى نقطة نهاية الخادم الخاص بك لتفعيل البحث في الويب وإعادة الصياغة.' };
}

</script>

</body>
</html>
